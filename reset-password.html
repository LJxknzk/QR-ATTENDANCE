<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset Password — ONE TAP QR Attendance</title>
  <link rel="stylesheet" href="CSS/stuff.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <style>
    /* Override body for a centered single-column layout */
    body {
      justify-content: center;
      align-items: center;
      padding: 100px 20px 40px;
    }
    .reset-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 480px;
    }
    .reset-card {
      background-color: #7badd8;
      border-radius: 20px;
      padding: 36px 30px 28px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .reset-card h2 {
      font-family: "DM Sans", sans-serif;
      font-size: 2rem;
      font-weight: 700;
      color: #0c1821;
      margin: 0 0 6px;
    }
    .reset-card .subtitle {
      font-family: "DM Sans", sans-serif;
      font-size: 0.95rem;
      color: #1a3045;
      text-align: center;
      margin-bottom: 22px;
    }
    .reset-card label {
      align-self: flex-start;
      margin-left: 4px;
      font-family: "DM Sans", sans-serif;
      font-size: 1rem;
      color: #0c1821;
      margin-bottom: 4px;
    }
    .reset-card input[type=text],
    .reset-card input[type=email],
    .reset-card input[type=password] {
      font-family: "DM Sans", sans-serif;
      background-color: #ccc9dc;
      border: none;
      border-radius: 12px;
      padding: 0 14px;
      font-size: 1rem;
      width: 100%;
      height: 50px;
      margin-bottom: 18px;
      transition: background-color 0.15s ease-in;
    }
    .reset-card input:focus {
      background-color: #b1aebf;
      outline: none;
    }
    /* Code input */
    .code-inputs {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .code-inputs input {
      width: 52px;
      height: 60px;
      text-align: center;
      font-size: 1.7rem;
      font-weight: 700;
      font-family: "DM Sans", sans-serif;
      background-color: #ccc9dc;
      border: 2px solid transparent;
      border-radius: 12px;
      transition: border-color 0.15s, background-color 0.15s;
      color: #0c1821;
    }
    .code-inputs input:focus {
      border-color: #324a5f;
      background-color: #b1aebf;
      outline: none;
    }
    .btn-primary {
      background-color: #324a5f;
      color: #fff;
      border: none;
      border-radius: 24px;
      font-family: "DM Sans", sans-serif;
      font-weight: 700;
      font-size: 1.15rem;
      width: 100%;
      height: 52px;
      cursor: pointer;
      transition: transform 0.15s ease-in-out, background-color 0.15s ease-in;
      margin-top: 4px;
    }
    .btn-primary:hover { background-color: #0c1821; transform: scale(1.03); }
    .btn-primary:active { background-color: #080f14; transform: scale(0.97); }
    .btn-primary:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

    .btn-link {
      background: none;
      border: none;
      color: #1a3045;
      font-family: "DM Sans", sans-serif;
      font-size: 0.9rem;
      text-decoration: underline;
      cursor: pointer;
      margin-top: 12px;
    }
    .btn-link:hover { color: #0c1821; }

    /* Feedback / error messages */
    .msg {
      font-family: "DM Sans", sans-serif;
      font-size: 0.9rem;
      padding: 10px 14px;
      border-radius: 8px;
      margin-bottom: 14px;
      width: 100%;
      text-align: center;
      display: none;
    }
    .msg.error { background: #f8d7da; color: #721c24; display: block; }
    .msg.success { background: #d4edda; color: #155724; display: block; }
    .msg.info { background: #d1ecf1; color: #0c5460; display: block; }

    /* Timer / resend */
    .timer-text {
      font-family: "DM Sans", sans-serif;
      font-size: 0.85rem;
      color: #1a3045;
      margin-top: 10px;
    }

    /* Strength indicator */
    .pw-strength {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #ccc9dc;
      margin: -10px 0 12px;
      overflow: hidden;
    }
    .pw-strength .bar {
      height: 100%;
      width: 0%;
      border-radius: 3px;
      transition: width 0.3s, background 0.3s;
    }
    .pw-strength .bar.weak { width: 33%; background: #e74c3c; }
    .pw-strength .bar.medium { width: 66%; background: #f39c12; }
    .pw-strength .bar.strong { width: 100%; background: #27ae60; }
    .pw-hint {
      font-family: "DM Sans", sans-serif;
      font-size: 0.8rem;
      color: #1a3045;
      margin: -8px 0 14px;
      align-self: flex-start;
      margin-left: 4px;
    }

    /* Step indicator */
    .steps {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .steps .dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #ccc9dc;
      transition: background 0.3s;
    }
    .steps .dot.active { background: #324a5f; }
    .steps .dot.done { background: #27ae60; }

    /* Hide steps */
    .step { display: none; width: 100%; flex-direction: column; align-items: center; }
    .step.active { display: flex; }

    /* Back to login */
    .back-link {
      margin-top: 18px;
      font-family: "DM Sans", sans-serif;
      font-size: 0.9rem;
      color: #ccc9dc;
    }
    .back-link a {
      color: #7badd8;
      text-decoration: none;
      font-weight: 600;
    }
    .back-link a:hover { text-decoration: underline; }

    /* Success icon */
    .success-icon {
      font-size: 3.5rem;
      margin-bottom: 10px;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .reset-card { padding: 28px 18px 22px; }
      .reset-card h2 { font-size: 1.5rem; }
      .code-inputs input { width: 44px; height: 52px; font-size: 1.4rem; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-header">
      <p class="luis">ONE TAP</p>
      <p class="qr">QR Attendance</p>
    </div>
    <div class="create-container">
      <button class="create-button" onclick="window.location.href='/'">Back to Login</button>
    </div>
  </nav>

  <div class="reset-wrapper">
    <div class="reset-card">
      <!-- Step indicators -->
      <div class="steps">
        <div class="dot active" id="dot1"></div>
        <div class="dot" id="dot2"></div>
        <div class="dot" id="dot3"></div>
      </div>

      <!-- Feedback message -->
      <div class="msg" id="msg"></div>

      <!-- ========== STEP 1: Enter email ========== -->
      <div class="step active" id="step1">
        <h2>Reset Password</h2>
        <p class="subtitle">Enter your student email address. We'll send you a 6-digit verification code.</p>

        <label for="reset-email">Email</label>
        <input type="email" id="reset-email" placeholder="student@example.com" autocomplete="email" required />

        <button class="btn-primary" id="btn-send-code">Send Verification Code</button>
        <button class="btn-link" onclick="window.location.href='/'">← Back to Login</button>
      </div>

      <!-- ========== STEP 2: Enter code ========== -->
      <div class="step" id="step2">
        <h2>Enter Code</h2>
        <p class="subtitle" id="code-subtitle">A 6-digit code was sent to your email.</p>

        <div class="code-inputs" id="code-inputs">
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="one-time-code" />
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" />
        </div>

        <button class="btn-primary" id="btn-verify-code">Verify Code</button>
        <div class="timer-text" id="timer-text"></div>
        <button class="btn-link" id="btn-resend" style="display:none;">Resend Code</button>
        <button class="btn-link" onclick="goToStep(1)">← Use a different email</button>
      </div>

      <!-- ========== STEP 3: New password ========== -->
      <div class="step" id="step3">
        <h2>New Password</h2>
        <p class="subtitle">Choose a strong new password for your account.</p>

        <label for="new-pw">New Password</label>
        <input type="password" id="new-pw" placeholder="At least 6 characters" autocomplete="new-password" />
        <div class="pw-strength"><div class="bar" id="pw-bar"></div></div>
        <p class="pw-hint" id="pw-hint"></p>

        <label for="confirm-pw">Confirm Password</label>
        <input type="password" id="confirm-pw" placeholder="Re-enter password" autocomplete="new-password" />

        <button class="btn-primary" id="btn-reset-pw">Reset Password</button>
      </div>

      <!-- ========== STEP 4: Success ========== -->
      <div class="step" id="step4">
        <div class="success-icon">&#10003;</div>
        <h2>Password Reset!</h2>
        <p class="subtitle">Your password has been changed successfully. You can now log in with your new password.</p>
        <button class="btn-primary" onclick="window.location.href='/'">Go to Login</button>
      </div>
    </div>

    <p class="back-link">Remember your password? <a href="/">Log in</a></p>
  </div>

<script>
  // ==================== STATE ====================
  let currentStep = 1;
  let resetEmail = '';
  let resetToken = '';
  let countdownInterval = null;

  const msgEl     = document.getElementById('msg');
  const steps     = [null, document.getElementById('step1'), document.getElementById('step2'), document.getElementById('step3'), document.getElementById('step4')];
  const dots      = [null, document.getElementById('dot1'), document.getElementById('dot2'), document.getElementById('dot3')];

  // ==================== NAVIGATION ====================
  function goToStep(n) {
    steps.forEach((s, i) => { if (s) s.classList.remove('active'); });
    steps[n].classList.add('active');
    dots.forEach((d, i) => {
      if (!d) return;
      d.classList.remove('active', 'done');
      if (i < n) d.classList.add('done');
      else if (i === n) d.classList.add('active');
    });
    currentStep = n;
    clearMsg();
  }

  function showMsg(text, type) {
    msgEl.textContent = text;
    msgEl.className = 'msg ' + type;
  }
  function clearMsg() { msgEl.className = 'msg'; msgEl.textContent = ''; }

  // ==================== STEP 1: Request Code ====================
  document.getElementById('btn-send-code').addEventListener('click', async () => {
    const emailInput = document.getElementById('reset-email');
    resetEmail = emailInput.value.trim().toLowerCase();
    if (!resetEmail) { showMsg('Please enter your email address.', 'error'); return; }

    const btn = document.getElementById('btn-send-code');
    btn.disabled = true;
    btn.textContent = 'Sending…';
    clearMsg();

    try {
      const res = await fetch('/api/password-reset/request', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: resetEmail })
      });
      const data = await res.json();

      if (res.status === 429) {
        showMsg(data.error || 'Too many requests. Please wait.', 'error');
        btn.disabled = false;
        btn.textContent = 'Send Verification Code';
        return;
      }

      // Always move to step 2 (prevents email enumeration)
      document.getElementById('code-subtitle').textContent =
        `A 6-digit code was sent to ${maskEmail(resetEmail)}. Check your inbox (and spam folder).`;
      goToStep(2);
      startCountdown(60);
      focusFirstCodeInput();
    } catch (err) {
      showMsg('Network error. Please try again.', 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Send Verification Code';
    }
  });

  // ==================== STEP 2: Verify Code ====================
  // Code input auto-advance + paste support
  const codeBoxes = document.querySelectorAll('#code-inputs input');
  codeBoxes.forEach((box, i) => {
    box.addEventListener('input', (e) => {
      const val = e.target.value.replace(/\D/g, '');
      e.target.value = val.charAt(0) || '';
      if (val && i < codeBoxes.length - 1) codeBoxes[i + 1].focus();
    });
    box.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !e.target.value && i > 0) {
        codeBoxes[i - 1].focus();
      }
    });
    box.addEventListener('paste', (e) => {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '').slice(0, 6);
      paste.split('').forEach((ch, idx) => { if (codeBoxes[idx]) codeBoxes[idx].value = ch; });
      if (paste.length > 0) codeBoxes[Math.min(paste.length, codeBoxes.length) - 1].focus();
    });
  });

  function getCodeValue() {
    return Array.from(codeBoxes).map(b => b.value).join('');
  }
  function clearCodeInputs() {
    codeBoxes.forEach(b => { b.value = ''; });
  }
  function focusFirstCodeInput() {
    clearCodeInputs();
    setTimeout(() => codeBoxes[0].focus(), 200);
  }

  document.getElementById('btn-verify-code').addEventListener('click', async () => {
    const code = getCodeValue();
    if (code.length !== 6) { showMsg('Please enter the full 6-digit code.', 'error'); return; }

    const btn = document.getElementById('btn-verify-code');
    btn.disabled = true;
    btn.textContent = 'Verifying…';
    clearMsg();

    try {
      const res = await fetch('/api/password-reset/verify', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: resetEmail, code: code })
      });
      const data = await res.json();

      if (data.success) {
        resetToken = data.reset_token;
        goToStep(3);
        document.getElementById('new-pw').focus();
      } else {
        showMsg(data.error || 'Verification failed.', 'error');
        clearCodeInputs();
        codeBoxes[0].focus();
      }
    } catch (err) {
      showMsg('Network error. Please try again.', 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Verify Code';
    }
  });

  // Resend button
  document.getElementById('btn-resend').addEventListener('click', async () => {
    const btn = document.getElementById('btn-resend');
    btn.disabled = true;
    clearMsg();
    try {
      const res = await fetch('/api/password-reset/request', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: resetEmail })
      });
      const data = await res.json();
      if (res.status === 429) {
        showMsg(data.error, 'error');
      } else {
        showMsg('A new code has been sent to your email.', 'info');
        clearCodeInputs();
        codeBoxes[0].focus();
        startCountdown(60);
      }
    } catch (err) {
      showMsg('Network error.', 'error');
    } finally {
      btn.disabled = false;
    }
  });

  // Countdown timer for resend
  function startCountdown(seconds) {
    const timerEl = document.getElementById('timer-text');
    const resendBtn = document.getElementById('btn-resend');
    resendBtn.style.display = 'none';
    if (countdownInterval) clearInterval(countdownInterval);

    let remaining = seconds;
    timerEl.textContent = `Resend available in ${remaining}s`;
    countdownInterval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(countdownInterval);
        timerEl.textContent = '';
        resendBtn.style.display = 'inline';
      } else {
        timerEl.textContent = `Resend available in ${remaining}s`;
      }
    }, 1000);
  }

  // ==================== STEP 3: Set New Password ====================
  const pwInput = document.getElementById('new-pw');
  const pwBar   = document.getElementById('pw-bar');
  const pwHint  = document.getElementById('pw-hint');

  pwInput.addEventListener('input', () => {
    const pw = pwInput.value;
    let strength = 0;
    if (pw.length >= 6) strength++;
    if (pw.length >= 10) strength++;
    if (/[A-Z]/.test(pw) && /[0-9]/.test(pw)) strength++;
    if (/[^A-Za-z0-9]/.test(pw)) strength++;

    pwBar.className = 'bar';
    if (strength <= 1) { pwBar.classList.add('weak'); pwHint.textContent = 'Weak — try adding numbers and uppercase.'; }
    else if (strength <= 2) { pwBar.classList.add('medium'); pwHint.textContent = 'Medium — add special characters for extra strength.'; }
    else { pwBar.classList.add('strong'); pwHint.textContent = 'Strong password!'; }
    if (!pw) { pwBar.className = 'bar'; pwHint.textContent = ''; }
  });

  document.getElementById('btn-reset-pw').addEventListener('click', async () => {
    const newPw = document.getElementById('new-pw').value;
    const confirmPw = document.getElementById('confirm-pw').value;

    if (!newPw) { showMsg('Please enter a new password.', 'error'); return; }
    if (newPw.length < 6) { showMsg('Password must be at least 6 characters.', 'error'); return; }
    if (newPw !== confirmPw) { showMsg('Passwords do not match.', 'error'); return; }

    const btn = document.getElementById('btn-reset-pw');
    btn.disabled = true;
    btn.textContent = 'Resetting…';
    clearMsg();

    try {
      const res = await fetch('/api/password-reset/reset', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: resetEmail,
          reset_token: resetToken,
          new_password: newPw,
          confirm_password: confirmPw
        })
      });
      const data = await res.json();

      if (data.success) {
        goToStep(4);
      } else {
        showMsg(data.error || 'Reset failed. Please try again.', 'error');
      }
    } catch (err) {
      showMsg('Network error. Please try again.', 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Reset Password';
    }
  });

  // ==================== HELPERS ====================
  function maskEmail(email) {
    const [user, domain] = email.split('@');
    if (user.length <= 2) return user[0] + '•••@' + domain;
    return user[0] + '•'.repeat(Math.min(user.length - 2, 5)) + user[user.length - 1] + '@' + domain;
  }

  // Allow Enter key to submit on each step
  document.getElementById('reset-email').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('btn-send-code').click();
  });
  codeBoxes[codeBoxes.length - 1].addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('btn-verify-code').click();
  });
  document.getElementById('confirm-pw').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('btn-reset-pw').click();
  });
</script>
</body>
</html>
